# Secret Echo - AI Companion Backend

## Overview

Secret Echo Backend is the Node.js backend for an AI companion application that enables users to interact with an AI in specialized modes such as Doctor, Chef, and more. The backend is built with TypeScript for type safety, uses MongoDB for data persistence, and implements JWT token authorization with session-based authentication. Real-time communication is facilitated through WebSocket, with two distinct WebSocket setups: one for user-to-AI chat and another for integration with Gemini AI Live to generate AI responses. All chat interactions are saved in MongoDB with context for each user, ensuring a seamless and personalized experience.

## Features

- **User Authentication**:
  - Sign-up and sign-in with email, encrypted password, first name, and last name.
  - Session-based authentication using JWT tokens for secure API access.
  - User details and sessions are stored in MongoDB.
- **Real-Time Communication**:
  - Two WebSocket setups:
    1. `/gemini-live`: For integration with Gemini AI Live to generate AI responses.
  - Chat messages are saved in MongoDB with context (e.g., sender, timestamp).
- **Gemini AI Live Integration**: Stream live AI responses using the Gemini AI Live service (`/gemini-live` route).
- **MongoDB Integration**: Persistent storage for user data, sessions, and chat history.
- **Middleware**: Secures each Rest API and Websocket event on each interaction.
- **Redis Integration**: Implemented Rate limiting via `Redis-Cloud` with `Sliding window` algorithm
- **WebSocket Authorization**: Secure WebSocket connections with JWT token validation.
- **AI Companion Modes**:
  - Users can create AI companions with predefined modes (e.g., Doctor, Chef).
  - Messages are exchanged in real-time, with responses generated by Gemini AI Live.
- **Session Management**:
  - Each sign-in creates a session, ensuring secure access to APIs using JWT tokens.
  - Logout functionality to invalidate sessions.
- **Chat History**:
  - Users can retrieve their chat history with an AI companion.
- **Jest Testing**: Comprehensive unit tests for all services, with all tests passing successfully.
- **Rate Limiting**: Protects the API from abuse by limiting the number of requests per user, rate limiting is done by Redis.

## Tech Stack

- **Node.js**: Backend runtime environment.
- **TypeScript**: For type-safe development.
- **MongoDB**: Database for storing user data, sessions, and chat history.
- **Express**: Web framework for handling HTTP requests.
- **WebSocket (ws)**: For real-time communication between users and the AI.
- **JWT (jsonwebtoken)**: For token-based authentication.
- **Mongoose**: ODM for MongoDB.
- **Gemini AI Live**: For generating AI companion responses.
- **bcrypt**: For password encryption.
- **Joi**: For request validation.
- **Testing**: Jest
- **Logging**: Custom logging with `oplog`
- **Rate Limiting**: Implemented to prevent API abuse with `Redis`
- **npm**: Package manager for dependency management.

## Project Structure

```
secret-echo/
├── app/               # Application logic (bootstrap, routes, etc.)
├── config/            # Configuration management
├── controllers/       # API controllers
├── db/                # Database connection logic
├── entities/          # Database models/entities
├── helpers/           # Utility functions (e.g., Gemini AI Live integration)
├── middleware/        # Express middleware (e.g., authentication)
├── models/            # Mongoose models
├── node_modules/      # Dependencies
├── oplog/             # Logging utility
├── providers/         # Service providers
├── repositories/      # Data access layer
├── services/          # Business logic
├── tests/             # Jest tests for all services
├── utils/             # General utilities
├── validators/        # Input validation (e.g., using Joi)
├── .env               # Environment variables
├── .gitignore         # Git ignore file
├── Dockerfile         # Docker configuration
├── index.ts           # Entry point
├── package.json       # Project metadata and dependencies
├── package-lock.json    # Lockfile for npm
├── prettier.config.js # Prettier configuration
├── tsconfig.json      # TypeScript configuration
```

## API Endpoints

All API endpoints are prefixed with `/api/v1`.

### User Authentication

- **POST /api/v1/auth/signup**  
  Register a new user.  
  **Request Body**:

  ```json
  {
  	"email": "user@example.com",
  	"password": "yourpassword",
  	"first_name": "John",
  	"last_name": "Doe"
  }
  ```

  **Response**:

  ```json
  {
  	"success": true,
  	"data": {
  		"user_id": "user_pid",
  		"email": "user@example.com",
  		"first_name": "John",
  		"last_name": "Doe",
  		"token": "jwt_token"
  	},
  	"errors": []
  }
  ```

- **POST /api/v1/auth/login**  
  Authenticate a user and create a session.  
  **Request Body**:

  ```json
  {
  	"email": "user@example.com",
  	"password": "yourpassword"
  }
  ```

  **Response**:

  ```json
  {
  	"success": true,
  	"data": {
  		"token": "jwt_token",
  		"user": {
  			"user_id": "user_pid",
  			"email": "user@example.com",
  			"first_name": "John",
  			"last_name": "Doe"
  		}
  	},
  	"errors": []
  }
  ```

- **POST /api/v1/auth/logout**  
  Log out a user and invalidate their session.  
  **Headers**:

  - `Authorization: Bearer <jwt_token>`  
    **Response**:

  ```json
  {
  	"success": true,
  	"data": { "message": "Logged out successfully" },
  	"errors": []
  }
  ```

- **GET /api/v1/users/me**  
  Retrieve the authenticated user’s details.  
  **Headers**:

  - `Authorization: Bearer <jwt_token>`  
    **Response**:

  ```json
  {
  	"success": true,
  	"data": {
  		"user_pid": "user_id",
  		"email": "user@example.com",
  		"first_name": "John",
  		"last_name": "Doe",
  		"created_at": "2025-05-08T12:00:00Z",
  		"updated_at": "2025-05-08T12:00:00Z"
  	},
  	"errors": []
  }
  ```

### AI Companion

- **POST /api/v1/create/chat**  
  Create a new AI companion instance.  
  **Headers**:

  - `Authorization: Bearer <jwt_token>`  
    **Request Body**:

  ```json
  {
  	"companionCode": "doctor"
  }
  ```

  **Response**:

  ```json
  {
  	"success": true,
  	"data": { "message": "AI Companion created successfully" },
  	"errors": []
  }
  ```

- **GET /api/v1/chat_history**  
  Retrieve the chat history for an AI companion.  
  **Headers**:

  - `Authorization: Bearer <jwt_token>`  
    **Query Parameters**:
  - `companionCode`: The AI companion mode (e.g., `doctor`).  
    **Response**:

  ```json
  {
  	"success": true,
  	"data": {
  		"chat": [
  			{
  				"content": "I have a headache",
  				"sender": "user",
  				"timestamp": "2025-05-08T12:00:00Z"
  			},
  			{
  				"content": "You might need to rest and drink water.",
  				"sender": "companion",
  				"timestamp": "2025-05-08T12:01:00Z"
  			}
  		]
  	},
  	"errors": []
  }
  ```

## WebSocket Routes

The backend supports real-time communication through WebSocket.

- **/gemini-live**  
  Establishes a WebSocket connection for real-time user-to-AI companion chat.  
  **Usage**:

  - Connect to `ws://localhost:3000/chat?companion_code={companion_code}&token={jwt_token}`.
  - Send messages in the format:

    ```json
    {
    	"message": "I have a headache"
    }
    ```

  - Receive responses from the AI companion in real-time.

## Setup Instructions

### Prerequisites

- Node.js (v18.18.0 or higher)
- MongoDB (local or cloud instance)
- npm (package manager)
- Docker (optional, for containerization)

### Installation

1. **Clone the repository**:

   ```bash
   git clone <repository-url>
   cd secret-echo
   ```

2. **Install dependencies**:

   ```bash
   npm install
   ```

3. **Set up environment variables**:

   - Create a `.env` file in the root directory.
   - Add the following variables (adjust values as needed):

     ```
      APP_NAME=secret-echo
      APP_ENV=development
      APP_PORT=3000

      TOKEN_SECRET={{TOKEN_SECRET}}

      MONGO_URI={{TOKEN_SECRET}}

      GEMINI_API_KEY={{GEMINI_API_KEY}}

      REDIS_CLOUD_HOST={{REDIS_CLOUD_HOST}}
      REDIS_CLOUD_PORT={{REDIS_CLOUD_PORT}}
      REDIS_CLOUD_USERNAME={{REDIS_CLOUD_USERNAME}}
      REDIS_CLOUD_PASSWORD={{REDIS_CLOUD_PASSWORD}}
      REDIS_CLOUD_TLS={{REDIS_CLOUD_TLS}}
     ```

4. **Build the project**:

   ```bash
   npm run build
   ```

5. **Run the application**:

   - Development mode (with hot-reload):

     ```bash
     npm run dev
     ```

   - Production mode (after building):

     ```bash
     node build/index.js
     ```

### Running Tests

The project includes comprehensive unit tests for all services, written with Jest. All tests have passed successfully, ensuring the reliability of the application.

To run the tests:

```bash
npm test
```

### Docker Setup (Optional)

1. **Build the Docker image**:

   ```bash
   docker build -t secret-echo .
   ```

2. **Run the container**:

   ```bash
   docker run -p 3000:3000 --env-file .env secret-echo
   ```

## Usage

1. **Sign Up**:
   - Send a POST request to `/api/v1/auth/signup` with the required user details.
   - A JWT token will be returned for authentication.
2. **Sign In**:
   - Send a POST request to `/api/v1/auth/login` with email and password.
   - A session will be created, and a JWT token will be returned.
3. **Chat with AI Companion**:
   - Connect to the WebSocket endpoint `ws://localhost:3000/gemini-live`.
   - Select an AI mode (e.g., Doctor, Chef) and send messages.
   - Responses from the AI (via Gemini AI Live) will be sent in real-time and saved in MongoDB.
4. **Retrieve Chat History**:
   - Use the `/api/v1/chat_history` endpoint to fetch past conversations.

## Rate Limiting

To prevent abuse and ensure fair usage, the application implements rate limiting on all API endpoints. Each user is limited to a specific number of requests per minute (configurable via environment variables). This helps protect the server from denial-of-service (DoS) attacks and ensures a smooth experience for all users.

To configure rate limiting, set the following environment variable:

```
RATE_LIMIT_REQUESTS_PER_MINUTE=45
```

This limits each user to 45 requests per minute. Exceeding this limit will result in a `429 Too Many Requests` response.

## License

This project is licensed under the ISC License. See the `LICENSE` file for details.

## Contact

For questions or support, reach out to the project maintainer at [shashank272004@gmail.com](mailto:shashank272004@gmail.com).
